<?xml version="1.0"?>
<project default="Post-Build" xmlns="http://nant.sf.net/release/0.92/nant.xsd">

  <!--
  Uncomment these few lines if the nAnd Contrib binaries are not in the same directory than the nAnt files.
  Bear in mind these lines are an example, therefore configure what has to be configured ;)
  -->
  <!--<property name="nantcontrib-dir"
            value="${path::combine(nant::get-base-directory(), '../../NAntContrib')}"
            overwrite="false" />

  <loadtasks assembly="${path::combine(nantcontrib-dir, 'bin/NAnt.Contrib.Tasks.dll')}"/>-->

  <!-- Properties -->
  <property name="release-dir" value="c:\mvvm-core-Release" overwrite="false"/>
  <property name="code-dir" value="${release-dir}\bin"/>
  <property name="sln-file" value="Probel.Mvvm.sln" overwrite="false"/>
  <property name="tool-dir" value="${release-dir}\bin\tools"/>
  <property name="build-mode" value="release" overwrite="false"/>
  <property name="svn-repository" value="http://mvvm-core.googlecode.com/svn/trunk/"/>
  <property name="nest-dir" value="${release-dir}\mvvm-core\"/>

  <!-- Targets -->
  <target name="Pre-Build" description="Export the code locally">
    <echo message="========================================================================"/>
    <echo message="release-dir   : ${release-dir}"/>
    <echo message="code-dir      : ${code-dir}"/>
    <echo message="sln-file      : ${sln-file}"/>
    <echo message="tool-dir      : ${tool-dir}"/>
    <echo message="build-mode    : ${build-mode}"/>
    <echo message="svn-repository: ${svn-repository}"/>
    <echo message="========================================================================"/>

    <echo message="Clean release directory..."/>
    <delete>
      <fileset basedir="${release-dir}\">
        <include name="**.*"/>
      </fileset>
    </delete>
    <delete dir="${release-dir}\bin"/>   
	
    <echo message="Checkout the code..."/>
    <exec program="svn.exe"
          commandline="checkout &quot;${svn-repository}&quot; &quot;${code-dir}&quot; -q"/> 
  </target>

  <target name="Build" description="Build the solution" depends="Pre-Build">
    <!-- Build the solution -->
    <echo message="Building..."/>
    <echo message="Build mode: ${build-mode}"/>
	<echo message="Building file: ${code-dir}\src\${sln-file}"/>
    <msbuild project="${code-dir}\${sln-file}"
             verbosity="Minimal">
      <property name="Configuration" value="${build-mode}"/>
    </msbuild>	
  </target>

  <target name="Post-Build" description="Execute the post build actions" depends="Build">
   <!-- Here should go the unit tests execution... -->
  </target>

  <!-- Create a release package with the binaries -->
  <target name="Release" description="Zip the binaries and rename the file" depends="Post-Build">
    <loadfile file="${code-dir}\src\Version.cs" property="version-file"/>
    <regex pattern="AssemblyVersion\(\&quot;(?'version'1.*.*.*)*\&quot;"
           input="${version-file}"/>
    <echo message="Version number: ${version}"/>
	
	
	<echo message="Prepare the nest"/>
	<mkdir dir="${nest-dir}\"/>
	
	<echo message="Copy: ${code-dir}\bin\Probel.Mvvm.Core\bin\${build-mode}\"/>
	<echo message="To  : ${nest-dir}"/>
	<copy todir="${nest-dir}\">
		<fileset basedir="${code-dir}\src\Probel.Mvvm.Core\bin\${build-mode}\">
			<exclude name="*.vshost.exe"/>
			<exclude name="*.vshost.exe.config"/>
			<include name="*.dll"/>
			<include name="*.xml"/>
        </fileset>
    </copy>
	
	<zip zipfile="${release-dir}\mvvm-core.${version}.zip">
		<fileset basedir="${nest-dir}\..\">
			<exclude name="bin\**" />
			<include name="**.*"/>        
      </fileset>
    </zip>
	
	<echo message="Delete all in ${release-dir}"/>
    <delete>
      <fileset basedir="${release-dir}">
        <exclude name="*.zip"/>
        <include name="**.*"/>
      </fileset>
    </delete>

  </target>
</project>